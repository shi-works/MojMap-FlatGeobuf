<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="utf-8" />
    <title>æ³•å‹™çœåœ°å›³XMLï¼ˆFlatGeobufï¼‰</title>
    <meta name="description" content="MapLibre_FlatGeobuf" />
    <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet" />
    <script src="https://unpkg.com/flatgeobuf@3.26.2/dist/flatgeobuf-geojson.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }

        .maplibregl-popup .maplibregl-popup-content {
            padding: 8px 10px;
            font: 12px/14px Arial, Helvetica, sans-serif;
            color: black;
            background: white;
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.4);
            border-radius: 5px;
            width: 240x;
        }
    </style>
</head>

<body>
    <div id="map"></div>
    <script>
        // DOMãŒãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸå¾Œã«å®Ÿè¡Œ
        document.addEventListener("DOMContentLoaded", async () => {
            var map = new maplibregl.Map({
                container: 'map',
                style: 'https://tile2.openstreetmap.jp/styles/osm-bright-ja/style.json',
                center: [139.46009, 35.89367],
                zoom: 15.05,
                hash: true,
                attributionControl: false
            });

            // ã‚ºãƒ¼ãƒ ãƒ»å›è»¢
            map.addControl(new maplibregl.NavigationControl());

            // ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãƒ¢ãƒ¼ãƒ‰ã®ã‚ªãƒ³ã‚ªãƒ•
            map.addControl(new maplibregl.FullscreenControl());

            // ç¾åœ¨ä½ç½®è¡¨ç¤º
            map.addControl(new maplibregl.GeolocateControl({
                positionOptions: {
                    enableHighAccuracy: false
                },
                fitBoundsOptions: { maxZoom: 18 },
                trackUserLocation: true,
                showUserLocation: true
            }));

            // ã‚¹ã‚±ãƒ¼ãƒ«è¡¨ç¤º
            map.addControl(new maplibregl.ScaleControl({
                maxWidth: 200,
                unit: 'metric'
            }));

            // Attributionã‚’æŠ˜ã‚ŠãŸãŸã¿è¡¨ç¤º
            map.addControl(new maplibregl.AttributionControl({
                compact: true,
                customAttribution: 'ï¼ˆ<a href="https://twitter.com/shi__works" target="_blank">Twitter</a> | <a href="https://github.com/shi-works/MojMap-FlatGeobuf" target="_blank">Github</a>ï¼‰ '
            }));

            function handleHeaderMeta(headerMeta) {
                console.log("metadata", headerMeta);
            }

            // FlatGeobufãƒ‡ãƒ¼ã‚¿ã®å–å¾—
            const response = await fetch(
                "https://xs489works.xsrv.jp/FlatGeobuf-data/MOJ-XML/11201__9_r.fgb"
            );

            var hoveredStateId = null;

            // å‚è€ƒï¼šhttps://flatgeobuf.org/examples/maplibre/
            map.on("load", async () => {
                // GeoJSONã«ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚º
                const fc = { type: "FeatureCollection", features: [] };
                let i = 0;
                for await (const f of flatgeobuf.deserialize(
                    response.body,
                    undefined,
                    handleHeaderMeta
                )) {
                    fc.features.push({ ...f, id: i });
                    i += 1;
                }

                // æ³•å‹™çœåœ°å›³ã‚½ãƒ¼ã‚¹
                map.addSource("moj-fgb", {
                    type: "geojson",
                    data: fc,
                    attribution: '<a href="https://www.geospatial.jp/ckan/dataset/aigid-moj-11201">ã€Œç™»è¨˜æ‰€å‚™ä»˜ãƒ‡ãƒ¼ã‚¿å·è¶Šå¸‚ã€ï¼ˆæ³•å‹™çœï¼‰ã‚’ã‚‚ã¨ã«å¤‰æ›å‡¦ç†ã—ã¦ä½œæˆ</a>',
                    generateId: true
                });

                // æ³•å‹™çœåœ°å›³ãƒãƒªã‚´ãƒ³ãƒ¬ã‚¤ãƒ¤
                map.addLayer({
                    id: "moj-fill",
                    type: "fill",
                    source: "moj-fgb",
                    paint: {
                        "fill-color": "#FF9393",
                        "fill-opacity": [
                            "case",
                            ["boolean", ["feature-state", "hover"], false],
                            0.9,
                            0.4
                        ]
                    }
                });

                // æ³•å‹™çœåœ°å›³ãƒ©ã‚¤ãƒ³ãƒ¬ã‚¤ãƒ¤
                map.addLayer({
                    id: "moj-line",
                    type: "line",
                    source: "moj-fgb",
                    paint: {
                        'line-color': '#FF3232',
                        "line-opacity": 1.0,
                        "line-width": 1
                    }
                });

                // ãƒãƒªã‚´ãƒ³ãƒ¬ã‚¤ãƒ¤ã®ãƒ›ãƒãƒ¼åŠ¹æœ
                const id = 'moj-fill';
                const sourceName = 'moj-fgb';
                map.on('mousemove', id, function (e) {
                    if (e.features.length > 0) {
                        if (hoveredStateId) {
                            map.setFeatureState(
                                { source: sourceName, id: hoveredStateId },
                                { hover: false }
                            );
                        }
                        hoveredStateId = e.features[0].id;
                        map.setFeatureState(
                            { source: sourceName, id: hoveredStateId },
                            { hover: true }
                        );
                    }
                });

                map.on('mouseleave', id, function () {
                    if (hoveredStateId) {
                        map.setFeatureState(
                            { source: sourceName, id: hoveredStateId },
                            { hover: false }
                        );
                    }
                    hoveredStateId = null;
                });

            });

            // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¡¨ç¤º
            map.on('click', 'moj-fill', (e) => {
                var lng = e.lngLat.lng;
                var lat = e.lngLat.lat;

                var zahyokei = e.features[0].properties['åº§æ¨™ç³»'];
                var sokuchikeihambetsu = e.features[0].properties['æ¸¬åœ°åˆ¤åˆ¥'];
                var chizumei = e.features[0].properties['åœ°å›³å'];
                var shikuchosonkodo = e.features[0].properties['å¸‚ç”ºæ‘C'];
                var shikuchosommei = e.features[0].properties['å¸‚ç”ºæ‘å'];
                var oazakodo = e.features[0].properties['å¤§å­—ã‚³ãƒ¼ãƒ‰'];
                var chomokukodo = e.features[0].properties['ä¸ç›®ã‚³ãƒ¼ãƒ‰'];
                var koazakodo = e.features[0].properties['å°å­—ã‚³ãƒ¼ãƒ‰'];
                var yobikodo = e.features[0].properties['äºˆå‚™ã‚³ãƒ¼ãƒ‰'];
                var oazamei = e.features[0].properties['å¤§å­—å'];
                var koazamei = e.features[0].properties['å°å­—å'];
                var chiban = e.features[0].properties['åœ°ç•ª'];
                var seidokubun = e.features[0].properties['ç²¾åº¦åŒºåˆ†'];
                var zahyochishubetsu = e.features[0].properties['åº§æ¨™å€¤ç¨®åˆ¥'];

                if (zahyokei === undefined) { zahyokei = "-" };
                if (sokuchikeihambetsu === undefined) { sokuchikeihambetsu = "-" };
                if (chizumei === undefined) { chizumei = "-" };
                if (shikuchosonkodo === undefined) { shikuchosonkodo = "-" };
                if (shikuchosommei === undefined) { shikuchosommei = "-" };
                if (oazakodo === undefined) { oazakodo = "-" };
                if (chomokukodo === undefined) { chomokukodo = "-" };
                if (koazakodo === undefined) { koazakodo = "-" };
                if (yobikodo === undefined) { yobikodo = "-" };
                if (oazamei === undefined) { oazamei = "-" };
                if (koazamei === undefined) { koazamei = "-" };
                if (chiban === undefined) { chiban = "-" };
                if (seidokubun === undefined) { seidokubun = "-" };
                if (zahyochishubetsu === undefined) { zahyochishubetsu = "-" };

                new maplibregl.Popup()
                    .setLngLat(e.lngLat)
                    .setHTML('åº§æ¨™ç³»: ' + zahyokei + '<br>'
                        + 'æ¸¬åœ°ç³»åˆ¤åˆ¥: ' + sokuchikeihambetsu + '<br>'
                        + 'åœ°å›³å: ' + chizumei + '<br>'
                        + 'å¸‚åŒºç”ºæ‘ã‚³ãƒ¼ãƒ‰: ' + shikuchosonkodo + '<br>'
                        + 'å¸‚åŒºç”ºæ‘å: ' + shikuchosommei + '<br>'
                        + 'å¤§å­—ã‚³ãƒ¼ãƒ‰: ' + oazakodo + '<br>'
                        + 'ä¸ç›®ã‚³ãƒ¼ãƒ‰: ' + chomokukodo + '<br>'
                        + 'å°å­—ã‚³ãƒ¼ãƒ‰: ' + koazakodo + '<br>'
                        + 'äºˆå‚™ã‚³ãƒ¼ãƒ‰: ' + yobikodo + '<br>'
                        + 'å¤§å­—å: ' + oazamei + '<br>'
                        + 'å°å­—å: ' + koazamei + '<br>'
                        + 'åœ°ç•ª: ' + chiban + '<br>'
                        + 'ç²¾åº¦åŒºåˆ†: ' + seidokubun + '<br>'
                        + 'åº§æ¨™å€¤ç¨®åˆ¥: ' + zahyochishubetsu + '<br>'
                        + 'åº§æ¨™: ' + lat.toFixed(7) + "," + lng.toFixed(7) + '<br>'
                        + '<a href=\https://www.google.com/maps?q=' + lat + "," + lng + "&hl=ja' target='_blank'>ğŸŒGoogle Maps</a>")
                    .addTo(map);
            });
        });

    </script>
</body>

</html>