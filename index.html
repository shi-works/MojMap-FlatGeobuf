<!DOCTYPE html>
<html lang="ja">

<head>
    <title>æ³•å‹™çœåœ°å›³XMLï¼ˆFlatGeobufï¼‰</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="MapLibre_FlatGeobuf" />
    <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet" />
    <script src="https://unpkg.com/flatgeobuf@3.26.2/dist/flatgeobuf-geojson.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }

        .maplibregl-popup .maplibregl-popup-content {
            padding: 8px 10px;
            font: 12px/14px Arial, Helvetica, sans-serif;
            color: black;
            background: white;
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.4);
            border-radius: 5px;
            width: 240x;
        }

        #controls {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 10;
            background-color: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.4);
        }
    </style>
</head>

<body>
    <div id="map"></div>
    <div id="controls">
        <button id="downloadKML">Download as KML</button>
    </div>
    <script>
        // DOMãŒãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸå¾Œã«å®Ÿè¡Œ
        document.addEventListener("DOMContentLoaded", async () => {
            let fc = { type: "FeatureCollection", features: [] }; // ã“ã“ã§ fc ã‚’å®šç¾©

            // ç‹¬è‡ªã®GeoJSONã‹ã‚‰KMLã¸ã®å¤‰æ›é–¢æ•°
            function geojsonToKML(geojson) {
                // KMLã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆ
                const parser = new DOMParser();
                const kmlDocument = parser.parseFromString('<kml xmlns="http://www.opengis.net/kml/2.2"></kml>', 'application/xml');
                const kml = kmlDocument.documentElement;

                const documentElement = kmlDocument.createElement('Document');
                kml.appendChild(documentElement);

                // æŒ‡å®šã•ã‚ŒãŸã‚¹ã‚¿ã‚¤ãƒ«ã‚’è¿½åŠ 
                const styleElement = kmlDocument.createElement('Style');
                const lineStyleElement = kmlDocument.createElement('LineStyle');
                const colorElement = kmlDocument.createElement('color');
                colorElement.textContent = "ffff0000";
                const widthElement = kmlDocument.createElement('width');
                widthElement.textContent = "1";

                lineStyleElement.appendChild(colorElement);
                lineStyleElement.appendChild(widthElement);
                styleElement.appendChild(lineStyleElement);

                const polyStyleElement = kmlDocument.createElement('PolyStyle');
                const polyColorElement = kmlDocument.createElement('color');
                polyColorElement.textContent = "00ffffff";

                polyStyleElement.appendChild(polyColorElement);
                styleElement.appendChild(polyStyleElement);

                documentElement.appendChild(styleElement);

                // Schemaã®ä½œæˆ
                const schemaElement = kmlDocument.createElement('Schema');
                schemaElement.setAttribute('name', 'attributes');
                schemaElement.setAttribute('id', 'attributes');

                // ã™ã¹ã¦ã®ãƒ•ã‚£ãƒ¼ãƒãƒ£ã®å±æ€§ã‚’å–å¾—
                let allProperties = {};
                geojson.features.forEach(feature => {
                    for (let prop in feature.properties) {
                        allProperties[prop] = true;
                    }
                });

                for (let prop in allProperties) {
                    const simpleFieldElement = kmlDocument.createElement('SimpleField');
                    simpleFieldElement.setAttribute('name', prop);
                    simpleFieldElement.setAttribute('type', 'string');
                    schemaElement.appendChild(simpleFieldElement);
                }

                documentElement.appendChild(schemaElement);

                // å„ãƒ•ã‚£ãƒ¼ãƒãƒ£ã‚’Placemarkã¨ã—ã¦è¿½åŠ 
                geojson.features.forEach(feature => {
                    const placemarkElement = kmlDocument.createElement('Placemark');

                    // ExtendedDataã®è¿½åŠ 
                    const extendedDataElement = kmlDocument.createElement('ExtendedData');
                    const schemaDataElement = kmlDocument.createElement('SchemaData');
                    schemaDataElement.setAttribute('schemaUrl', '#attributes');

                    for (let prop in allProperties) { // ã™ã¹ã¦ã®å±æ€§ã«å¯¾ã—ã¦
                        const simpleDataElement = kmlDocument.createElement('SimpleData');
                        simpleDataElement.setAttribute('name', prop);
                        simpleDataElement.textContent = feature.properties[prop] !== undefined ? feature.properties[prop] : "NULL"; // å±æ€§ãŒundefinedã®å ´åˆã¯ "NULL" ã¨ã—ã¦å‡ºåŠ›
                        schemaDataElement.appendChild(simpleDataElement);
                    }

                    extendedDataElement.appendChild(schemaDataElement);
                    placemarkElement.appendChild(extendedDataElement);

                    // ã‚¸ã‚ªãƒ¡ãƒˆãƒªã®å¤‰æ›ï¼ˆã“ã®ä¾‹ã§ã¯ãƒãƒªã‚´ãƒ³ã®ã¿ã‚’å¯¾è±¡ã¨ã—ã¾ã™ï¼‰
                    if (feature.geometry.type === 'Polygon') {
                        const polygonElement = kmlDocument.createElement('Polygon');
                        const outerBoundaryIsElement = kmlDocument.createElement('outerBoundaryIs');
                        const linearRingElement = kmlDocument.createElement('LinearRing');
                        const coordinatesElement = kmlDocument.createElement('coordinates');

                        coordinatesElement.textContent = feature.geometry.coordinates[0].map(coord => `${coord[0]},${coord[1]}`).join(' ');

                        linearRingElement.appendChild(coordinatesElement);
                        outerBoundaryIsElement.appendChild(linearRingElement);
                        polygonElement.appendChild(outerBoundaryIsElement);
                        placemarkElement.appendChild(polygonElement);
                    }

                    // Placemarkã‚’Documentã«è¿½åŠ 
                    documentElement.appendChild(placemarkElement);
                });

                return kmlDocument;
            }

            // ãƒãƒƒãƒ—ã®åˆæœŸåŒ–
            var map = new maplibregl.Map({
                container: 'map',
                style: 'https://tile2.openstreetmap.jp/styles/osm-bright-ja/style.json',
                center: [139.45806, 35.90154],
                zoom: 11.95,
                hash: true,
                attributionControl: false
            });

            // ã‚ºãƒ¼ãƒ ãƒ»å›è»¢
            map.addControl(new maplibregl.NavigationControl());

            // ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãƒ¢ãƒ¼ãƒ‰ã®ã‚ªãƒ³ã‚ªãƒ•
            map.addControl(new maplibregl.FullscreenControl());

            // ç¾åœ¨ä½ç½®è¡¨ç¤º
            map.addControl(new maplibregl.GeolocateControl({
                positionOptions: {
                    enableHighAccuracy: false
                },
                fitBoundsOptions: { maxZoom: 18 },
                trackUserLocation: true,
                showUserLocation: true
            }));

            // ã‚¹ã‚±ãƒ¼ãƒ«è¡¨ç¤º
            map.addControl(new maplibregl.ScaleControl({
                maxWidth: 200,
                unit: 'metric'
            }));

            // Attributionã‚’æŠ˜ã‚ŠãŸãŸã¿è¡¨ç¤º
            map.addControl(new maplibregl.AttributionControl({
                compact: true,
                customAttribution: 'ï¼ˆ<a href="https://twitter.com/shi__works" target="_blank">Twitter</a> | <a href="https://github.com/shi-works/MojMap-FlatGeobuf" target="_blank">Github</a>ï¼‰ '
            }));

            function handleHeaderMeta(headerMeta) {
                console.log("metadata", headerMeta);
            }

            // FlatGeobufãƒ‡ãƒ¼ã‚¿ã®å–å¾—
            const response = await fetch(
                "https://xs489works.xsrv.jp/FlatGeobuf-data/MOJ-XML/11201__9_r.fgb"
            );

            var hoveredStateId = null;

            // å‚è€ƒï¼šhttps://flatgeobuf.org/examples/maplibre/
            map.on("load", async () => {
                // GeoJSONã«ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚º
                // const fc = { type: "FeatureCollection", features: [] };
                let i = 0;
                for await (const f of flatgeobuf.deserialize(
                    response.body,
                    undefined,
                    handleHeaderMeta
                )) {
                    fc.features.push({ ...f, id: i });
                    i += 1;
                }

                // æ³•å‹™çœåœ°å›³ã‚½ãƒ¼ã‚¹
                map.addSource("moj-fgb", {
                    type: "geojson",
                    data: fc,
                    attribution: '<a href="https://www.geospatial.jp/ckan/dataset/aigid-moj-11201">ã€Œç™»è¨˜æ‰€å‚™ä»˜ãƒ‡ãƒ¼ã‚¿å·è¶Šå¸‚ã€ï¼ˆæ³•å‹™çœï¼‰ã‚’å¤‰æ›å‡¦ç†ã—ã¦ä½œæˆ</a>',
                    generateId: true
                });

                // æ³•å‹™çœåœ°å›³ãƒãƒªã‚´ãƒ³ãƒ¬ã‚¤ãƒ¤
                map.addLayer({
                    id: "moj-fill",
                    type: "fill",
                    source: "moj-fgb",
                    paint: {
                        "fill-color": "#FF9393",
                        "fill-opacity": [
                            "case",
                            ["boolean", ["feature-state", "hover"], false],
                            0.9,
                            0.4
                        ]
                    }
                });

                // æ³•å‹™çœåœ°å›³ãƒ©ã‚¤ãƒ³ãƒ¬ã‚¤ãƒ¤
                map.addLayer({
                    id: "moj-line",
                    type: "line",
                    source: "moj-fgb",
                    paint: {
                        'line-color': '#FF3232',
                        "line-opacity": 1.0,
                        "line-width": 1
                    }
                });

                // ãƒãƒªã‚´ãƒ³ãƒ¬ã‚¤ãƒ¤ã®ãƒ›ãƒãƒ¼åŠ¹æœ
                const id = 'moj-fill';
                const sourceName = 'moj-fgb';
                map.on('mousemove', id, function (e) {
                    if (e.features.length > 0) {
                        if (hoveredStateId) {
                            map.setFeatureState(
                                { source: sourceName, id: hoveredStateId },
                                { hover: false }
                            );
                        }
                        hoveredStateId = e.features[0].id;
                        map.setFeatureState(
                            { source: sourceName, id: hoveredStateId },
                            { hover: true }
                        );
                    }
                });

                map.on('mouseleave', id, function () {
                    if (hoveredStateId) {
                        map.setFeatureState(
                            { source: sourceName, id: hoveredStateId },
                            { hover: false }
                        );
                    }
                    hoveredStateId = null;
                });

            });

            // XMLDocumentã‚’æ–‡å­—åˆ—ã«å¤‰æ›ã™ã‚‹é–¢æ•°
            function xmlToString(xmlDom) {
                return new XMLSerializer().serializeToString(xmlDom);
            }

            // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            document.getElementById('downloadKML').addEventListener('click', () => {
                let kmlDomObject = geojsonToKML(fc);  // `fc` ã¯ä»¥å‰ã«ä½œæˆã—ãŸ GeoJSON ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
                const kmlData = xmlToString(kmlDomObject); // ã“ã“ã§æ–‡å­—åˆ—ã«å¤‰æ›
                const blob = new Blob([kmlData], { type: 'application/vnd.google-earth.kml+xml' });
                const url = URL.createObjectURL(blob);

                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = 'data.kml';

                document.body.appendChild(a);
                a.click();

                setTimeout(() => {
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                }, 100);
            });

            // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¡¨ç¤º
            map.on('click', 'moj-fill', (e) => {
                var lng = e.lngLat.lng;
                var lat = e.lngLat.lat;

                var zahyokei = e.features[0].properties['åº§æ¨™ç³»'];
                var sokuchikeihambetsu = e.features[0].properties['æ¸¬åœ°åˆ¤åˆ¥'];
                var chizumei = e.features[0].properties['åœ°å›³å'];
                var shikuchosonkodo = e.features[0].properties['å¸‚ç”ºæ‘C'];
                var shikuchosommei = e.features[0].properties['å¸‚ç”ºæ‘å'];
                var oazakodo = e.features[0].properties['å¤§å­—ã‚³ãƒ¼ãƒ‰'];
                var chomokukodo = e.features[0].properties['ä¸ç›®ã‚³ãƒ¼ãƒ‰'];
                var koazakodo = e.features[0].properties['å°å­—ã‚³ãƒ¼ãƒ‰'];
                var yobikodo = e.features[0].properties['äºˆå‚™ã‚³ãƒ¼ãƒ‰'];
                var oazamei = e.features[0].properties['å¤§å­—å'];
                var koazamei = e.features[0].properties['å°å­—å'];
                var chiban = e.features[0].properties['åœ°ç•ª'];
                var seidokubun = e.features[0].properties['ç²¾åº¦åŒºåˆ†'];
                var zahyochishubetsu = e.features[0].properties['åº§æ¨™å€¤ç¨®åˆ¥'];

                if (zahyokei === undefined) { zahyokei = "-" };
                if (sokuchikeihambetsu === undefined) { sokuchikeihambetsu = "-" };
                if (chizumei === undefined) { chizumei = "-" };
                if (shikuchosonkodo === undefined) { shikuchosonkodo = "-" };
                if (shikuchosommei === undefined) { shikuchosommei = "-" };
                if (oazakodo === undefined) { oazakodo = "-" };
                if (chomokukodo === undefined) { chomokukodo = "-" };
                if (koazakodo === undefined) { koazakodo = "-" };
                if (yobikodo === undefined) { yobikodo = "-" };
                if (oazamei === undefined) { oazamei = "-" };
                if (koazamei === undefined) { koazamei = "-" };
                if (chiban === undefined) { chiban = "-" };
                if (seidokubun === undefined) { seidokubun = "-" };
                if (zahyochishubetsu === undefined) { zahyochishubetsu = "-" };

                new maplibregl.Popup()
                    .setLngLat(e.lngLat)
                    .setHTML('åº§æ¨™ç³»: ' + zahyokei + '<br>'
                        + 'æ¸¬åœ°ç³»åˆ¤åˆ¥: ' + sokuchikeihambetsu + '<br>'
                        + 'åœ°å›³å: ' + chizumei + '<br>'
                        + 'å¸‚åŒºç”ºæ‘ã‚³ãƒ¼ãƒ‰: ' + shikuchosonkodo + '<br>'
                        + 'å¸‚åŒºç”ºæ‘å: ' + shikuchosommei + '<br>'
                        + 'å¤§å­—ã‚³ãƒ¼ãƒ‰: ' + oazakodo + '<br>'
                        + 'ä¸ç›®ã‚³ãƒ¼ãƒ‰: ' + chomokukodo + '<br>'
                        + 'å°å­—ã‚³ãƒ¼ãƒ‰: ' + koazakodo + '<br>'
                        + 'äºˆå‚™ã‚³ãƒ¼ãƒ‰: ' + yobikodo + '<br>'
                        + 'å¤§å­—å: ' + oazamei + '<br>'
                        + 'å°å­—å: ' + koazamei + '<br>'
                        + 'åœ°ç•ª: ' + chiban + '<br>'
                        + 'ç²¾åº¦åŒºåˆ†: ' + seidokubun + '<br>'
                        + 'åº§æ¨™å€¤ç¨®åˆ¥: ' + zahyochishubetsu + '<br>'
                        + 'åº§æ¨™: ' + lat.toFixed(7) + "," + lng.toFixed(7) + '<br>'
                        + '<a href=\https://www.google.com/maps?q=' + lat + "," + lng + "&hl=ja' target='_blank'>ğŸŒGoogle Maps</a>")
                    .addTo(map);
            });
        });
    </script>
</body>

</html>